<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>usort</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles2.css" type="text/css" />
</head>
<body><h1><b><u>usort</u></b></h1>When ordering information, developers can use two methods:<br />• <strong>order by</strong> in a SQL request;<br />• <strong>usort</strong> in PHP code.<br />The function <strong>usort</strong> is often used with the function <strong>create_function</strong>  to dynamically generate the "sorting" function, based on  user-controlled information. If the web application lacks potent  filtering and validation, this can lead to code execution.<br />By injecting a single quote, we can get an idea of what is going on:<br />Parse error: syntax error, unexpected '',$b-&gt;id'' (T_CONSTANT_ENCAPSED_STRING) in /var/www/index.php(29) : <br />runtime-created function on line 1<br /><br />Warning: usort() expects parameter 2 to be a valid callback, no array or string given in /var/www/index.php<br /> on line 29<br /><br />The source code of the function looks like the following:<br />ZEND_FUNCTION(create_function)<br />{<br />  [...]<br />  eval_code = (char *) emalloc(eval_code_length);<br />  sprintf(eval_code, "function " LAMBDA_TEMP_FUNCNAME "(%s){%s}", Z_STRVAL_PP(z_function_args), Z_STRVAL_PP(z_function_code));<br /><br />  eval_name = zend_make_compiled_string_description("runtime-created function" TSRMLS_CC);<br />  retval = zend_eval_string(eval_code, NULL, eval_name TSRMLS_CC);<br />  [...]<br />We can see that the code that will be evaluated is put inside curly brackets <strong>{...}</strong>, and we will need this information to correctly finish the syntax, after our injection.<br />As opposed to the previous code injection, here, you are not  injecting inside single or double quotes. We know that we need to close  the statement with <strong>}</strong> and comment out the rest of the code using <strong>//</strong> or <strong>#</strong> (with encoding). We can try poking around with:<br />• <strong>?order=id;}//</strong>: we get an error message (<strong>Parse error: syntax error, unexpected ';'</strong>). We are probably missing one or more brackets.<br />• <strong>?order=id);}//</strong>: we get a warning. That seems about right.<br />• <strong>?order=id));}//</strong>: we get an error message (<strong>Parse error: syntax error, unexpected ')' i</strong>). We probably have too many closing brackets.<br />Since we now know how to finish the code correctly (a warning does  not stop the execution flow), we can inject arbitrary code and gain code  execution using <strong>?order=id);}system('uname%20-a');//</strong> for example.<br /></body></html>